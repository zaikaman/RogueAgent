openapi: 3.0.3
info:
  title: Rogue Crypto Alpha Oracle API
  description: Backend REST API for Rogue crypto scanning system, deployed on Heroku
  version: 1.0.0
  contact:
    name: Rogue Team
    
servers:
  - url: https://rogue-oracle.herokuapp.com
    description: Production (Heroku)
  - url: http://localhost:3000
    description: Local development

paths:
  /api/run:
    post:
      summary: Trigger 20-minute swarm execution
      description: |
        Manually triggers the ADK-TS agent swarm to scan crypto ecosystem and generate signal/intel.
        Normally called by Cron-Job.org every 20 minutes. Can be triggered manually for testing.
      operationId: triggerRun
      tags:
        - Execution
      security:
        - ApiKeyAuth: []
      responses:
        '202':
          description: Swarm execution started (async)
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [started]
                  run_id:
                    type: string
                    format: uuid
                  estimated_completion:
                    type: string
                    format: date-time
                example:
                  status: started
                  run_id: "550e8400-e29b-41d4-a716-446655440000"
                  estimated_completion: "2025-11-20T10:22:00Z"
        '429':
          description: Too many requests (rate limit: 1 per 20 minutes)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/run-status:
    get:
      summary: Get latest run status
      description: Returns the most recent swarm execution result (signal, intel, or skip)
      operationId: getRunStatus
      tags:
        - Status
      responses:
        '200':
          description: Latest run status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunStatus'
        '404':
          description: No runs found (empty database)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/logs:
    get:
      summary: Get historical runs
      description: Returns paginated list of past runs with optional type filtering
      operationId: getLogs
      tags:
        - History
      parameters:
        - name: limit
          in: query
          description: Number of runs to return (default 20, max 100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: Pagination offset
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: type
          in: query
          description: Filter by run type
          schema:
            type: string
            enum: [signal, intel, skip]
      responses:
        '200':
          description: List of runs
          content:
            application/json:
              schema:
                type: object
                properties:
                  runs:
                    type: array
                    items:
                      $ref: '#/components/schemas/Run'
                  pagination:
                    type: object
                    properties:
                      total:
                        type: integer
                      limit:
                        type: integer
                      offset:
                        type: integer
                      has_more:
                        type: boolean

  /api/tiers/verify:
    post:
      summary: Verify wallet tier via on-chain data
      description: Checks Solana blockchain for $RGE holdings and returns tier (NONE/SILVER/GOLD/DIAMOND)
      operationId: verifyTier
      tags:
        - Tiers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - wallet_address
              properties:
                wallet_address:
                  type: string
                  description: Solana wallet public key (base58)
                  example: "7xKXtg2CW87d97TXJSDpbD5jBkheTqA83TZRuJosgAsU"
                telegram_user_id:
                  type: integer
                  description: Optional Telegram user ID to link wallet
                  example: 123456789
      responses:
        '200':
          description: Tier verification successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TierVerification'
        '400':
          description: Invalid wallet address
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '504':
          description: Blockchain RPC timeout (>5 seconds)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/custom-requests:
    post:
      summary: Submit custom token analysis request (Diamond tier only)
      description: Diamond tier users can request one custom analysis per day
      operationId: createCustomRequest
      tags:
        - Custom Requests
      security:
        - WalletAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - wallet_address
                - token_symbol
              properties:
                wallet_address:
                  type: string
                  description: Requesting user's wallet (must be Diamond tier)
                  example: "7xKXtg2CW87d97TXJSDpbD5jBkheTqA83TZRuJosgAsU"
                token_symbol:
                  type: string
                  description: Token to analyze
                  example: "BONK"
                token_contract:
                  type: string
                  description: Optional contract address for precision
                  example: "DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263"
      responses:
        '201':
          description: Request created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CustomRequest'
        '403':
          description: User not Diamond tier or daily quota exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '400':
          description: Invalid request data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    get:
      summary: Get user's custom request history
      description: Returns all custom requests for authenticated wallet
      operationId: getCustomRequests
      tags:
        - Custom Requests
      security:
        - WalletAuth: []
      parameters:
        - name: wallet_address
          in: query
          required: true
          description: User's wallet address
          schema:
            type: string
      responses:
        '200':
          description: List of custom requests
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CustomRequest'

  /health:
    get:
      summary: Health check endpoint
      description: Returns server health status (used by Cron-Job.org to keep dyno awake)
      operationId: healthCheck
      tags:
        - System
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy]
                  timestamp:
                    type: string
                    format: date-time
                  uptime_seconds:
                    type: integer

components:
  schemas:
    RunStatus:
      type: object
      properties:
        run_id:
          type: string
          format: uuid
        type:
          type: string
          enum: [signal, intel, skip]
        content:
          oneOf:
            - $ref: '#/components/schemas/SignalContent'
            - $ref: '#/components/schemas/IntelContent'
        public_posted_at:
          type: string
          format: date-time
          nullable: true
        confidence_score:
          type: integer
          minimum: 1
          maximum: 10
          nullable: true
        cycle_started_at:
          type: string
          format: date-time
        cycle_completed_at:
          type: string
          format: date-time
          nullable: true
        execution_time_ms:
          type: integer
          nullable: true
        next_run_in_seconds:
          type: integer
          description: Seconds until next 20-minute cycle

    Run:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [signal, intel, skip]
        content:
          oneOf:
            - $ref: '#/components/schemas/SignalContent'
            - $ref: '#/components/schemas/IntelContent'
        confidence_score:
          type: integer
          minimum: 1
          maximum: 10
          nullable: true
        created_at:
          type: string
          format: date-time

    SignalContent:
      type: object
      properties:
        token:
          type: object
          properties:
            symbol:
              type: string
              example: "BONK"
            name:
              type: string
              example: "Bonk"
            contract_address:
              type: string
              example: "DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263"
        entry_price:
          type: number
          format: double
          example: 0.0000085
        target_price:
          type: number
          format: double
          example: 0.0000120
        stop_loss:
          type: number
          format: double
          example: 0.0000070
        confidence:
          type: integer
          minimum: 1
          maximum: 10
          example: 8
        trigger_event:
          type: object
          properties:
            type:
              type: string
              enum: [kol_mention, whale_move, volume_spike, news_event]
            kol_handle:
              type: string
              nullable: true
            tweet_url:
              type: string
              nullable: true
            whale_wallets:
              type: array
              items:
                type: string
        analysis:
          type: string
          description: Human-readable analysis text
        formatted_tweet:
          type: string
          description: Ready-to-post X/Twitter content

    IntelContent:
      type: object
      properties:
        narrative:
          type: string
          description: Main narrative theme
          example: "Solana DePIN tokens heating up"
        insights:
          type: array
          items:
            type: string
          example: ["Helium up 45%", "Major VC rounds announced"]
        data_points:
          type: object
          properties:
            mindshare_surge:
              type: string
            whale_activity:
              type: string
            sentiment_score:
              type: number
        formatted_thread:
          type: string
          description: Full Agent Cookie-style thread

    TierVerification:
      type: object
      properties:
        wallet_address:
          type: string
        tier:
          type: string
          enum: [NONE, SILVER, GOLD, DIAMOND]
        rge_balance:
          type: number
          format: double
          description: $RGE tokens held
        rge_balance_usd:
          type: number
          format: double
          description: USD value of holdings
        verified_at:
          type: string
          format: date-time
        tier_benefits:
          type: object
          properties:
            early_access_minutes:
              type: integer
            sunday_reports:
              type: boolean
            custom_requests:
              type: boolean

    CustomRequest:
      type: object
      properties:
        id:
          type: string
          format: uuid
        token_symbol:
          type: string
        status:
          type: string
          enum: [pending, processing, completed, failed]
        analysis_result:
          type: object
          nullable: true
        requested_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        error_message:
          type: string
          nullable: true

    Error:
      type: object
      properties:
        error:
          type: string
          description: Human-readable error message
        code:
          type: string
          description: Machine-readable error code
          example: "TIER_REQUIRED"
        details:
          type: object
          nullable: true
          description: Additional error context

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for cron job authentication
    WalletAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Wallet signature authentication (future implementation)

tags:
  - name: Execution
    description: Swarm execution endpoints
  - name: Status
    description: Current run status
  - name: History
    description: Historical run logs
  - name: Tiers
    description: Wallet tier verification
  - name: Custom Requests
    description: Diamond tier custom analysis
  - name: System
    description: Health and monitoring
